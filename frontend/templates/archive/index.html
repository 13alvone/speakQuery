<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom SPL Console</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/normalize.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bulma.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* General Section Tabs */
        .menu {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .menu-list {
            display: flex;
            list-style-type: none;
            padding-left: 0;
        }
        .menu-list li {
            margin: 0 10px;
        }
        .menu-list li a {
            text-decoration: none;
            padding: 10px 15px;
            background-color: #f5f5f5;
            border: 1px solid #ccc;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .menu-list li a:hover {
            background-color: #ddd;
        }
        /* Query Box */
        #query {
            width: 85%;
            font-family: Consolas, monospace;
            font-size: 10pt;
            min-height: 150px; /* Approx. 10 lines of text */
            overflow-y: auto;
            resize: none; /* Disable manual resizing */
        }
        /* Results Table */
        #results {
            overflow-x: auto;
            white-space: nowrap;
        }
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .pagination button {
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <section class="section">
        <div class="container">
            <!-- General Section Tabs -->
            <div class="menu">
                <ul class="menu-list">
                    <li><a href="#">Search</a></li>
                    <li><a href="#">Manual Inputs</a></li>
                    <li><a href="#">Lookups</a></li>
                    <li><a href="#">Search History</a></li>
                    <li><a href="#">Scheduled Searches</a></li>
                    <li><a href="#">Scheduled Inputs</a></li>
                    <li><a href="#">Settings</a></li>
                </ul>
            </div>
            <div class="columns">
                <div class="column">
                    <div class="box">
                        <h1 class="title">Query Section</h1>
                        <textarea id="query" class="textarea" placeholder="Write your query here..."></textarea>
                        <button id="run-query-btn" class="button is-primary mt-2">Run Query</button>
                    </div>
                    <div class="box mt-2">
                        <div id="row-count" style="margin-bottom: 10px;"></div>
                        <h2 class="title">Results</h2>
                        <div id="results"></div>
                        <div class="pagination">
                            <button id="prev-page-btn" class="button">Previous</button>
                            <button id="next-page-btn" class="button">Next</button>
                        </div>
                        <button id="save-csv-btn" class="button is-link mt-2">Save as CSV</button>
                        <button id="save-json-btn" class="button is-link mt-2">Save as JSON</button>
                    </div>
                </div>
                <div class="column is-one-quarter">
                    <div class="box">
                        <h2 class="title">Query Syntax Helper</h2>
                        <p>Use the following syntax to build your query:</p>
                        <pre id="syntax-example"></pre>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <script>
    let currentPage = 1;
    let totalRows = 0;
    let rowsPerPage = 100;
    let queryResults = [];

    document.getElementById('run-query-btn').addEventListener('click', function() {
        const query = document.getElementById('query').value;
        axios.post('/run_query', { query: query })
            .then(response => {
                console.log('[DEBUG] Raw query result:', response);
                if (response.data.status === 'success') {
                    queryResults = response.data.results;
                    totalRows = queryResults.length;
                    document.getElementById('row-count').innerText = `[i] Rows: ${totalRows}`;
                    renderResults(currentPage);

                    // Reinsert the original query into the query box
                    const queryBox = document.getElementById('query');
                    if (queryBox) {
                        queryBox.value = query;
                        localStorage.setItem('savedQuery', query);
                        autoExpandQueryBox();
                    }
                } else {
                    console.error('[x] Query error:', response.data.message);
                    document.getElementById('results').innerHTML = '<p>[x] Error: ' + response.data.message + '</p>';
                }
            })
            .catch(error => {
                console.error('[x] Error running query:', error);
                if (error.response && error.response.data && error.response.data.message) {
                    document.getElementById('results').innerHTML = '<p>[x] Error: ' + error.response.data.message + '</p>';
                } else {
                    document.getElementById('results').innerHTML = '<p>[x] Error: An unknown error occurred.</p>';
                }
            });
    });

    document.getElementById('prev-page-btn').addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            renderResults(currentPage);
        }
    });

    document.getElementById('next-page-btn').addEventListener('click', function() {
        if (currentPage * rowsPerPage < totalRows) {
            currentPage++;
            renderResults(currentPage);
        }
    });

    document.getElementById('save-csv-btn').addEventListener('click', function() {
        saveResults('csv');
    });

    document.getElementById('save-json-btn').addEventListener('click', function() {
        saveResults('json');
    });

    function renderResults(page) {
        const start = (page - 1) * rowsPerPage;
        const end = Math.min(start + rowsPerPage, totalRows);
        const rows = queryResults.slice(start, end);
        let html = '<table class="table is-striped is-fullwidth"><thead><tr>';

        if (rows.length > 0) {
            Object.keys(rows[0]).forEach(key => {
                html += `<th>${key}</th>`;
            });
            html += '</tr></thead><tbody>';
            rows.forEach(row => {
                html += '<tr>';
                Object.values(row).forEach(value => {
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
        } else {
            html = '<p>[i] No results found.</p>';
        }

        document.getElementById('results').innerHTML = html;
    }

    function saveResults(format) {
        axios.post('/save_results', { results: queryResults, format: format })
            .then(response => {
                if (response.data.status === 'success') {
                    const link = document.createElement('a');
                    link.href = response.data.file_url;
                    link.download = response.data.file_name;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    console.error('[x] Save error:', response.data.message);
                }
            })
            .catch(error => {
                console.error('[x] Error saving results:', error);
            });
    }

    function autoExpandQueryBox() {
        const queryBox = document.getElementById('query');
        queryBox.style.height = 'auto';  // Reset the height
        queryBox.style.height = (queryBox.scrollHeight) + 'px';  // Set new height
    }

    document.getElementById('query').addEventListener('input', autoExpandQueryBox);

    // Load the saved query from local storage
    window.addEventListener('load', function() {
        const savedQuery = localStorage.getItem('savedQuery');
        if (savedQuery) {
            document.getElementById('query').value = savedQuery;
            autoExpandQueryBox();
        }
    });

    // Set the syntax example
    document.getElementById('syntax-example').textContent = `
        | table file="*"
        | select * from TARGET_FILE$
        | timerange("07/03/2018 03:00:00", "07/05/2019 04:00:00", TIMESTAMP)
        | eval test="test"
        | eval t2="header_3"
        | search header_1>= 400 AND header_2>= 500 AND (header_3 == "e" OR t2 == "that")
    `;
    </script>
</body>
</html>
