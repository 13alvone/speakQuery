<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scheduled Inputs</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/normalize.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bulma.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* Inline CSS Styles */

        /* Menu Styles */
        .menu {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .menu-list {
            display: flex;
            list-style-type: none;
            padding-left: 0;
        }

        .menu-list li {
            margin: 0 10px;
        }

        .menu-list li a {
            text-decoration: none;
            padding: 10px 15px;
            background-color: #f5f5f5;
            border: 1px solid #ccc;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .menu-list li a:hover {
            background-color: #ddd;
        }

        /* Dropdown Menu Styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-trigger .button {
            background-color: #fff;
            border: 1px solid #ccc;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
        }

        .dropdown.is-hoverable:hover .dropdown-menu {
            display: block;
        }

        .dropdown-content .dropdown-item {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .dropdown-content .dropdown-item:hover {
            background-color: #f1f1f1;
        }

        /* Run Button Styles */
        .button.is-success.run-btn {
            background-color: #28a745;
            color: white;
            border: none;
        }

        .button.is-success.run-btn:hover {
            background-color: #218838;
        }

        /* Table Styles */
        #scheduled-inputs-table {
            overflow-x: auto;
            white-space: nowrap;
        }

        /* Modal Styles */
        .modal .modal-content {
            max-width: 400px;
        }

        .modal .modal-content .box {
            text-align: center;
        }
    </style>
</head>
<body>
    <section class="section">
        <div class="container">
            <!-- General Section Tabs -->
            <nav class="menu">
                <ul class="menu-list">
                    <li><a href="/">Search</a></li>
                    <li><a href="/lookups.html">Lookups</a></li>
                    <li><a href="/history.html">Search History</a></li>
                    <li><a href="/saved_searches.html">Scheduled Searches</a></li>
                    <li><a href="/scheduled_input.html">Create Input</a></li>
                    <li><a href="/scheduled_inputs.html">Scheduled Inputs</a></li>
                    <li><a href="#">Settings</a></li>
                </ul>
            </nav>

            <div class="columns">
                <div class="column">
                    <div class="box">
                        <h1 class="title">Scheduled Inputs</h1>
                        <div id="scheduled-inputs-table">
                            <!-- Placeholder for dynamic content -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Modal -->
        <div id="notification-modal" class="modal">
            <div class="modal-background"></div>
            <div class="modal-content">
                <div class="box">
                    <p id="notification-message"></p>
                    <button class="button is-primary" id="modal-close-button">OK</button>
                </div>
            </div>
            <button class="modal-close is-large" aria-label="close" id="modal-close-icon"></button>
        </div>
    </section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadScheduledInputs();

    // Event delegation for dynamically created elements
    document.getElementById('scheduled-inputs-table').addEventListener('click', function(event) {
        const target = event.target;

        if (target.matches('.run-btn')) {
            const inputId = target.dataset.id;
            runInput(inputId);
        } else if (target.matches('.delete-btn')) {
            const inputId = target.dataset.id;
            deleteScheduledInput(inputId);
        } else if (target.matches('.toggle-disable-btn')) {
            const inputId = target.dataset.id;
            toggleDisable(inputId);
        } else if (target.matches('.clone-btn')) {
            const inputId = target.dataset.id;
            cloneScheduledInput(inputId);
        }
    });

    document.getElementById('modal-close-button').addEventListener('click', closeModal);
    document.getElementById('modal-close-icon').addEventListener('click', closeModal);

    function loadScheduledInputs() {
        axios.get('/get_scheduled_inputs')
            .then(response => {
                const data = response.data;
                if (data.status === 'success') {
                    const scheduledInputs = data.inputs;
                    renderScheduledInputsTable(scheduledInputs);
                } else {
                    showError('Error loading scheduled inputs.');
                }
            })
            .catch(error => {
                console.error('Error loading scheduled inputs:', error);
                showError('Error loading scheduled inputs.');
            });
    }

    function renderScheduledInputsTable(inputs) {
        const tableContainer = document.getElementById('scheduled-inputs-table');
        tableContainer.innerHTML = ''; // Clear previous content

        const table = document.createElement('table');
        table.className = 'table is-striped is-hoverable';

        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');

        const headers = [
            'Title', 'Description', 'Code', 'Cron Schedule', 'Subdirectory',
            'Created At', 'Overwrite', 'Status', 'Edit', 'Run', 'Actions'
        ];

        headers.forEach(headerText => {
            const th = document.createElement('th');
            th.innerText = headerText;
            headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');

        inputs.forEach(input => {
            const row = document.createElement('tr');

            // Title with link
            const titleCell = document.createElement('td');
            const titleLink = document.createElement('a');
            titleLink.href = `/scheduled_input/${input.id}`;
            titleLink.textContent = input.title;
            titleCell.appendChild(titleLink);
            row.appendChild(titleCell);

            // Other cells
            const cells = [
                input.description,
                input.code,
                input.cron_schedule,
                input.subdirectory || 'None',
                new Date(input.created_at * 1000).toLocaleString(),
                input.overwrite ? 'Yes' : 'No',
                input.disabled ? 'Disabled' : 'Active'
            ];

            cells.forEach(text => {
                const td = document.createElement('td');
                td.textContent = text;
                row.appendChild(td);
            });

            // Edit Actions
            const editCell = document.createElement('td');
            const editDropdown = createEditDropdown(input);
            editCell.appendChild(editDropdown);
            row.appendChild(editCell);

            // Run Button
            const runCell = document.createElement('td');
            const runButton = document.createElement('button');
            runButton.className = 'button is-success run-btn';
            runButton.textContent = 'Run';
            runButton.dataset.id = input.id;
            runCell.appendChild(runButton);
            row.appendChild(runCell);

            // Actions Cell (empty for now)
            const actionsCell = document.createElement('td');
            row.appendChild(actionsCell);

            tbody.appendChild(row);
        });

        table.appendChild(tbody);
        tableContainer.appendChild(table);
    }

    function createEditDropdown(input) {
        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown is-hoverable';

        const trigger = document.createElement('div');
        trigger.className = 'dropdown-trigger';
        const button = document.createElement('button');
        button.className = 'button';
        button.setAttribute('aria-haspopup', 'true');
        button.setAttribute('aria-controls', `dropdown-menu-${input.id}`);
        button.innerHTML = '<span>Edit</span><span class="icon is-small"><i class="fas fa-angle-down" aria-hidden="true"></i></span>';
        trigger.appendChild(button);

        const menu = document.createElement('div');
        menu.className = 'dropdown-menu';
        menu.id = `dropdown-menu-${input.id}`;
        menu.role = 'menu';

        const content = document.createElement('div');
        content.className = 'dropdown-content';

        const editInput = document.createElement('a');
        editInput.href = `/edit_scheduled_input/${input.id}`;
        editInput.className = 'dropdown-item';
        editInput.textContent = 'Edit Input';
        content.appendChild(editInput);

        const deleteAction = document.createElement('a');
        deleteAction.href = '#';
        deleteAction.className = 'dropdown-item delete-btn';
        deleteAction.dataset.id = input.id;
        deleteAction.textContent = 'Delete';
        content.appendChild(deleteAction);

        const toggleDisableAction = document.createElement('a');
        toggleDisableAction.href = '#';
        toggleDisableAction.className = 'dropdown-item toggle-disable-btn';
        toggleDisableAction.dataset.id = input.id;
        toggleDisableAction.textContent = input.disabled ? 'Enable' : 'Disable';
        content.appendChild(toggleDisableAction);

        const cloneAction = document.createElement('a');
        cloneAction.href = '#';
        cloneAction.className = 'dropdown-item clone-btn';
        cloneAction.dataset.id = input.id;
        cloneAction.textContent = 'Clone';
        content.appendChild(cloneAction);

        menu.appendChild(content);
        dropdown.appendChild(trigger);
        dropdown.appendChild(menu);

        return dropdown;
    }

    function runInput(inputId) {
        axios.post(`/run_scheduled_input/${inputId}`, {})
            .then(response => {
                if (response.data.status === 'success') {
                    showNotification('Input executed successfully.');
                } else {
                    showError('Error executing input.');
                }
            })
            .catch(error => {
                console.error('Error running input:', error);
                showError('Error running input.');
            });
    }

    function deleteScheduledInput(inputId) {
        if (confirm('Are you sure you want to delete this input?')) {
            axios.post(`/delete_scheduled_input/${inputId}`, {})
                .then(response => {
                    if (response.data.status === 'success') {
                        showNotification('Scheduled input deleted successfully.');
                        loadScheduledInputs();
                    } else {
                        showError('Error deleting scheduled input.');
                    }
                })
                .catch(error => {
                    console.error('Error deleting input:', error);
                    showError('Error deleting input.');
                });
        }
    }

    function toggleDisable(inputId) {
        axios.post(`/toggle_disable_scheduled_input/${inputId}`, {})
            .then(response => {
                if (response.data.status === 'success') {
                    showNotification('Scheduled input updated successfully.');
                    loadScheduledInputs();
                } else {
                    showError('Error updating scheduled input.');
                }
            })
            .catch(error => {
                console.error('Error updating input:', error);
                showError('Error updating input.');
            });
    }

    function cloneScheduledInput(inputId) {
        axios.post(`/clone_scheduled_input/${inputId}`, {})
            .then(response => {
                if (response.data.status === 'success') {
                    showNotification('Scheduled input cloned successfully.');
                    loadScheduledInputs();
                } else {
                    showError('Error cloning scheduled input.');
                }
            })
            .catch(error => {
                console.error('Error cloning input:', error);
                showError('Error cloning input.');
            });
    }

    function showNotification(message) {
        const modal = document.getElementById('notification-modal');
        const messageElement = document.getElementById('notification-message');
        messageElement.textContent = message;
        modal.classList.add('is-active');
    }

    function showError(message) {
        showNotification(message);
    }

    function closeModal() {
        const modal = document.getElementById('notification-modal');
        modal.classList.remove('is-active');
    }
});
</script>
</body>
</html>
