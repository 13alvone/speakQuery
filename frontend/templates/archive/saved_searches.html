<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Saved Searches</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/normalize.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bulma.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* Inline CSS Styles */

        /* Menu Styles */
        .menu {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .menu-list {
            display: flex;
            list-style-type: none;
            padding-left: 0;
        }

        .menu-list li {
            margin: 0 10px;
        }

        .menu-list li a {
            text-decoration: none;
            padding: 10px 15px;
            background-color: #f5f5f5;
            border: 1px solid #ccc;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .menu-list li a:hover {
            background-color: #ddd;
        }

        /* Dropdown Menu Styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-trigger .button {
            background-color: #fff;
            border: 1px solid #ccc;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
        }

        .dropdown.is-hoverable:hover .dropdown-menu {
            display: block;
        }

        .dropdown-content .dropdown-item {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .dropdown-content .dropdown-item:hover {
            background-color: #f1f1f1;
        }

        /* Run Button Styles */
        .button.is-success.run-btn {
            background-color: #28a745;
            color: white;
            border: none;
        }

        .button.is-success.run-btn:hover {
            background-color: #218838;
        }

        /* Table Styles */
        #saved-searches-table {
            overflow-x: auto;
            white-space: nowrap;
        }

        /* Modal Styles */
        .modal .modal-content {
            max-width: 400px;
        }

        .modal .modal-content .box {
            text-align: center;
        }
    </style>
</head>
<body>
    <section class="section">
        <div class="container">
            <nav class="menu">
                <ul class="menu-list">
                    <li><a href="/">Search</a></li>
                    <li><a href="/lookups.html">Lookups</a></li>
                    <li><a href="/history.html">Search History</a></li>
                    <li><a href="/saved_searches.html">Scheduled Searches</a></li>
                    <li><a href="/scheduled_input.html">Create Input</a></li>
                    <li><a href="/scheduled_inputs.html">Scheduled Inputs</a></li>
                    <li><a href="#">Settings</a></li>
                </ul>
            </nav>

            <div class="columns">
                <div class="column">
                    <div class="box">
                        <h1 class="title">Saved Searches</h1>
                        <div id="saved-searches-table">
                            <!-- Placeholder for dynamic content -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Modal -->
        <div id="notification-modal" class="modal">
            <div class="modal-background"></div>
            <div class="modal-content">
                <div class="box">
                    <p id="notification-message"></p>
                    <button class="button is-primary" id="modal-close-button">OK</button>
                </div>
            </div>
            <button class="modal-close is-large" aria-label="close" id="modal-close-icon"></button>
        </div>
    </section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadSavedSearches();

    // Event delegation for dynamically created elements
    document.getElementById('saved-searches-table').addEventListener('click', function(event) {
        const target = event.target;

        if (target.matches('.run-btn')) {
            const query = target.dataset.query;
            runSearch(query);
        } else if (target.matches('.delete-btn')) {
            const searchId = target.dataset.id;
            deleteSearch(searchId);
        } else if (target.matches('.toggle-disable-btn')) {
            const searchId = target.dataset.id;
            toggleDisable(searchId);
        } else if (target.matches('.clone-btn')) {
            const searchId = target.dataset.id;
            cloneSearch(searchId);
        }
    });

    document.getElementById('modal-close-button').addEventListener('click', function() {
        closeModal();
    });
    document.getElementById('modal-close-icon').addEventListener('click', closeModal);

    function loadSavedSearches() {
        axios.get('/get_saved_searches')
            .then(response => {
                const data = response.data;
                if (data.status === 'success') {
                    const savedSearches = data.searches;
                    renderSavedSearchesTable(savedSearches);
                } else {
                    showError('Error loading saved searches.');
                }
            })
            .catch(error => {
                console.error('Error loading saved searches:', error);
                showError('Error loading saved searches.');
            });
    }

    function renderSavedSearchesTable(searches) {
        const tableContainer = document.getElementById('saved-searches-table');
        tableContainer.innerHTML = ''; // Clear previous content

        const table = document.createElement('table');
        table.className = 'table is-striped is-hoverable';

        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');

        const headers = [
            'Search Title', 'Description', 'Cron Schedule', 'Trigger', 'Lookback',
            'Next Scheduled Time', 'Owner', 'Execution Count', 'Event Count', 'Status',
            'Email', 'Send Alert', 'Edit', 'Run', 'Actions'
        ];

        headers.forEach(headerText => {
            const th = document.createElement('th');
            th.innerText = headerText;
            headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');

        searches.forEach(search => {
            const row = document.createElement('tr');

            // Search Title
            const titleCell = document.createElement('td');
            const titleLink = document.createElement('a');
            titleLink.href = `/saved_search/${search.id}`;
            titleLink.innerText = search.title;
            titleCell.appendChild(titleLink);
            row.appendChild(titleCell);

            // Other cells
            const cells = [
                search.description,
                search.cron_schedule,
                search.trigger,
                search.lookback,
                search.next_scheduled_time,
                search.owner,
                search.execution_count,
                search.event_count,
                search.disabled ? 'Disabled' : 'Active',
                search.email_enabled,
                search.send_alert
            ];

            cells.forEach(text => {
                const td = document.createElement('td');
                td.innerText = text;
                row.appendChild(td);
            });

            // Edit Actions
            const editCell = document.createElement('td');
            const editDropdown = createEditDropdown(search);
            editCell.appendChild(editDropdown);
            row.appendChild(editCell);

            // Run Button
            const runCell = document.createElement('td');
            const runButton = document.createElement('button');
            runButton.className = 'button is-success run-btn';
            runButton.innerText = 'Run';
            runButton.dataset.query = search.query;
            runCell.appendChild(runButton);
            row.appendChild(runCell);

            // Actions Cell (empty for now)
            const actionsCell = document.createElement('td');
            row.appendChild(actionsCell);

            tbody.appendChild(row);
        });

        table.appendChild(tbody);
        tableContainer.appendChild(table);
    }

    function createEditDropdown(search) {
        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown is-hoverable';

        const trigger = document.createElement('div');
        trigger.className = 'dropdown-trigger';
        const button = document.createElement('button');
        button.className = 'button';
        button.setAttribute('aria-haspopup', 'true');
        button.setAttribute('aria-controls', `dropdown-menu-${search.id}`);
        button.innerHTML = '<span>Edit</span><span class="icon is-small"><i class="fas fa-angle-down" aria-hidden="true"></i></span>';
        trigger.appendChild(button);

        const menu = document.createElement('div');
        menu.className = 'dropdown-menu';
        menu.id = `dropdown-menu-${search.id}`;
        menu.role = 'menu';

        const content = document.createElement('div');
        content.className = 'dropdown-content';

        const editSearch = document.createElement('a');
        editSearch.href = `/edit_search/${search.id}`;
        editSearch.className = 'dropdown-item';
        editSearch.innerText = 'Edit Search';
        content.appendChild(editSearch);

        const editPermissions = document.createElement('a');
        editPermissions.href = `/edit_permissions/${search.id}`;
        editPermissions.className = 'dropdown-item';
        editPermissions.innerText = 'Edit Permissions';
        content.appendChild(editPermissions);

        const deleteAction = document.createElement('a');
        deleteAction.href = '#';
        deleteAction.className = 'dropdown-item delete-btn';
        deleteAction.dataset.id = search.id;
        deleteAction.innerText = 'Delete';
        content.appendChild(deleteAction);

        const toggleDisableAction = document.createElement('a');
        toggleDisableAction.href = '#';
        toggleDisableAction.className = 'dropdown-item toggle-disable-btn';
        toggleDisableAction.dataset.id = search.id;
        toggleDisableAction.innerText = search.disabled ? 'Enable' : 'Disable';
        content.appendChild(toggleDisableAction);

        const cloneAction = document.createElement('a');
        cloneAction.href = '#';
        cloneAction.className = 'dropdown-item clone-btn';
        cloneAction.dataset.id = search.id;
        cloneAction.innerText = 'Clone';
        content.appendChild(cloneAction);

        menu.appendChild(content);
        dropdown.appendChild(trigger);
        dropdown.appendChild(menu);

        return dropdown;
    }

    function runSearch(query) {
        localStorage.setItem('savedQuery', query);
        window.location.href = '/';
    }

    function deleteSearch(searchId) {
        if (confirm('Are you sure you want to delete this search?')) {
            axios.post(`/delete_search/${searchId}`, {})
                .then(response => {
                    if (response.data.status === 'success') {
                        showNotification('Saved search deleted successfully.');
                        loadSavedSearches();
                    } else {
                        showError('Error deleting saved search.');
                    }
                })
                .catch(error => {
                    console.error('Error deleting search:', error);
                    showError('Error deleting search.');
                });
        }
    }

    function toggleDisable(searchId) {
        axios.post(`/toggle_disable_search/${searchId}`, {})
            .then(response => {
                if (response.data.status === 'success') {
                    showNotification('Saved search updated successfully.');
                    loadSavedSearches();
                } else {
                    showError('Error updating saved search.');
                }
            })
            .catch(error => {
                console.error('Error updating search:', error);
                showError('Error updating search.');
            });
    }

    function cloneSearch(searchId) {
        axios.post(`/clone_search/${searchId}`, {})
            .then(response => {
                if (response.data.status === 'success') {
                    showNotification('Saved search cloned successfully.');
                    loadSavedSearches();
                } else {
                    showError('Error cloning saved search.');
                }
            })
            .catch(error => {
                console.error('Error cloning search:', error);
                showError('Error cloning search.');
            });
    }

    function showNotification(message) {
        const modal = document.getElementById('notification-modal');
        const messageElement = document.getElementById('notification-message');
        messageElement.textContent = message;
        modal.classList.add('is-active');
    }

    function showError(message) {
        showNotification(message);
    }

    function closeModal() {
        const modal = document.getElementById('notification-modal');
        modal.classList.remove('is-active');
    }
});
</script>
</body>
</html>
